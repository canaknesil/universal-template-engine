#! /bin/bash

BIN_DIR=$(dirname $BASH_SOURCE)
UTE_GEN_SCRIPT=$BIN_DIR/ute-gen-script
BASE_JL=$BIN_DIR/../julia/base.jl

if (( $# != 2 )); then
    echo "Illegal numner of arguments !"
    exit 1
fi

TEMPLATE=$1
TARGET=$2

if [ "$TEMPLATE" == "$TARGET" ]; then
    echo "Template file is the same with target file !"
    exit 1
fi


# xxx template -> julia
if ! (cat $BASE_JL && $UTE_GEN_SCRIPT < $TEMPLATE) > $TEMPLATE.jl
then
    echo
    echo "Error while script generation !"
    rm $TEMPLATE.jl
    exit 1
fi

# julia -> xxx
julia $TEMPLATE.jl | tee $TARGET
if ! $(exit ${PIPESTATUS[0]})
   then
    echo
    echo "Error while running generated script !"
    rm $TEMPLATE.jl $TARGET
    exit 2
fi

rm $TEMPLATE.jl
exit


